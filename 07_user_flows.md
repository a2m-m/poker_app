# 7. User Flows / Critical Scenarios（代表シナリオ）

このドキュメントは、MVPで実現すべき「ユーザー行動の脚本」を定義する。
実装AI（Codex）が機能を実装する際の優先順位・例外処理の基準として使う。

前提：
- キャッシュゲーム
- サイドポットなし（未対応）
- カードは物理。アプリはチップと進行を管理
- 端末は横持ちで回す（パス＆プレイ）

---

## 7.1 フロー記法（簡易）
- `UI:` ユーザー操作
- `APP:` アプリの反応（表示・計算・状態遷移）
- `RULE:` ルール/制約（MVPの前提）

---

## 7.2 フローA：新規ゲーム作成 → テーブル開始（最重要）
**目的**：2〜9人でゲームを開始できる。

1. `UI:` ホーム（`/`）で「新規ゲームを作成」
2. `APP:` `/setup` を表示
3. `UI:` 人数（2〜9）を選択
4. `APP:` プレイヤー入力欄が人数分になる
5. `UI:` 各プレイヤーの名前を入力
6. `UI:` 初期スタック、SB/BB を入力
7. `UI:` ボタン初期位置を選択 or ランダム
8. `APP:` 入力バリデーション（不足/不正があれば短文で警告、開始ボタン無効化も可）
9. `UI:` 「開始」
10. `APP:` `/table`へ遷移し、最初のハンドを `HAND_INIT` で開始
11. `APP:` SB/BBを自動徴収してポットに加算、手番を表示

受け入れ条件：
- 最小入力（名前/スタック/SB/BB）でテーブルが開始できる
- SB/BB徴収後のスタックとポットが矛盾しない

---

## 7.3 フローB：1ハンドを完走（チェック主体の最短）
**目的**：最短でラウンド遷移し、ショーダウンまで行ける。

1. `APP:` `PREFLOP_BETTING`、手番表示（〇〇さん）
2. `UI:` 手番プレイヤーが `Call` もしくは `Check` を選ぶ（可能な方）
3. `APP:` スタック/投入額/ポット/toCallを更新、次の手番へ
4. 参加中プレイヤー全員が「揃う」まで 2〜3 を繰り返す
5. `APP:` ラウンド終了を検知し、ガイド表示「フロップを3枚めくってください」
6. `UI:` 実カードでフロップをめくる（アプリには入力しない）
7. `APP:` `FLOP_BETTING`へ遷移し手番開始（通常はボタン左から）
8. 同様に Turn/River まで繰り返す
9. `APP:` `SHOWDOWN`へ遷移し「勝者を選択してください」を表示
10. `UI:` 勝者（1人）を選択
11. `APP:` ポットを勝者に付与し `HAND_END` → 次ハンドへ

受け入れ条件：
- Preflop→Flop→Turn→River→Showdown が止まらずに進行できる
- 勝者へポット付与後、次ハンドでボタン/SB/BBが1つ進む

---

## 7.4 フローC：ベット/レイズを含むラウンド（基本の賭け）
**目的**：Bet/Raise入力→他者のCall/Fold→ラウンドクローズが成立する。

1. `APP:` `AWAIT_ACTION`（手番）
2. `UI:` `Bet` を選択
3. `APP:` 金額入力（`AmountInput`）を表示
4. `UI:` 金額を入力し `確定`
5. `APP:` 入力値をバリデーション（負数/0/上限超過などは拒否）
6. `APP:` スタック/投入額/ポット/toCall を更新し、次の手番へ
7. `UI:` 他プレイヤーが `Call` または `Fold`（または `Raise`）
8. `APP:` 最後のベット/レイズへの応答が完了したらラウンド終了

受け入れ条件：
- Bet/Raise後に `toCall` が正しく更新される
- 不可能なアクション（チェック不可など）がUI上で抑止される

---

## 7.5 フローD：全員フォールドでハンド終了（ショーダウン無し）
**目的**：途中で全員がFoldしたら即終了できる。

1. `UI:` 途中で複数人が `Fold`
2. `APP:` ACTIVEが1人になった瞬間を検知
3. `APP:` `SHOWDOWN` をスキップし、「〇〇さんの勝ち（全員フォールド）」を表示
4. `APP:` 勝者にポット付与 → `HAND_END` → 次ハンドへ

受け入れ条件：
- ACTIVEが1人なら、どのラウンドでも即終了できる
- 付与処理後のポットは0に戻る

---

## 7.6 フローE：Undo（直前のアクションを戻す）
**目的**：誤タップ・入力ミスを最小コストで救済する。

1. `UI:` `/table` の `Undo` を押す
2. `APP:` 直前のアクション（1つ）を取り消し、状態を復元
   - スタック、投入額、ポット、手番、toCall 等を巻き戻す
3. `APP:` 手番表示も巻き戻した状態に一致させる

RULE:
- MVPは「直前1手」だけで良い
- 破壊的な戻しはConfirm不要（Undo自体が安全弁）

受け入れ条件：
- Undo後に数値矛盾が発生しない（ポット/投入額/スタックが一致）

---

## 7.7 フローF：役一覧を見る（困ったら開く）
**目的**：初心者が参照しても進行を止めない。

1. `UI:` テーブル右上（Utility）から「役」をタップ
2. `APP:` 役一覧モーダルを表示
3. `UI:` 閉じる
4. `APP:` `/table` に戻る（状態は変えない）

受け入れ条件：
- 1タップで開ける
- 閉じる導線が明確で、必ずテーブルに戻れる

---

## 7.8 フローG：勝者判定ツールを使う（任意）
**目的**：「どっち勝ち？」を任意入力で解決する（通常進行を邪魔しない）。

1. `UI:` Utilityから「判定」をタップ
2. `APP:` 判定ツールモーダルを表示
3. `UI:` 共有カード（最大5）を入力
4. `UI:` 判定したいプレイヤーを選び、手札2枚を入力
5. `UI:` 判定
6. `APP:` 勝者/同点/役名を表示
7. `UI:` 閉じる
8. `APP:` `/table` に戻る（ゲーム状態は変えない）

受け入れ条件：
- 入力不足なら判定せず、必要項目を短文表示する
- 判定ツールの利用はゲーム進行の必須ではない

---

## 7.9 例外：サイドポットが必要な状況になった場合（MVP未対応）
RULE:
- MVPはサイドポット非対応。
- 発生しそうな操作は可能な範囲で抑止する（例：スタック不足でのCall/Raise等の扱い）

APP（方針）：
- 抑止できない場合は警告を出す：
  - 「サイドポットは未対応です。このハンドは手計算で処理してください。」
- そのハンドの結果だけ、勝者への付与を手動入力できる導線（将来拡張）を検討
  - MVPでは「例外時はリセットしてやり直し」でも許容

---

## 7.10 MVPのクリティカルパス（最優先で通すべき道）
1. 新規作成 → テーブル開始（フローA）
2. 1ハンド完走（フローB）
3. ベット/レイズ（フローC）
4. 全員フォールド終了（フローD）
5. Undo（フローE）
6. 役一覧（フローF）
7. 任意判定（フローG）
